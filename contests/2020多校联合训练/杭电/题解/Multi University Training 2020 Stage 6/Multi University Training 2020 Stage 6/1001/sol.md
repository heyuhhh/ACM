# Road To The 3rd Building Review

## 题目描述

给定一个数列 $a$，以均匀随机的方式取出其中的一个非空子段，求子段平均值的期望。

数据范围：$1\le n\le 2\times 10^5$。

## 题解

可以考虑对序列中的每个数分别计算对期望的贡献。

首先计算第 $i$ 个数在多少个长度为 $j$ 的子段中出现。这样的子段可能的最左端为 $i-j+1$，可能的最右端为 $i+j-1$。需分情况讨论：

- 当 $j\le i\le n-j+1$ 时，出现次数为 $j$，这种情况是所有长度为 $j$ 的子段均存在，根据 $j\le i$ 还可知 $n+1-i\le n+1-j$，因此 $j\le i\le n-j+1\le n+1-i$；
- 当 $i<j$ 且 $i\le n-j+1$ 时，出现次数为 $i$，这种情况是所有长度为 $j$ 的子段可能的最左端超出原序列，但可能的最右端不会超出，根据 $i<j$ 可知 $n+1-j<n+1-i$，因此 $i<j,i\le n+1-j<n+1-i$；
- 当 $i\ge j$ 且 $i>n-j+1$ 时，出现次数为 $n-i+1$，这种情况是所有长度为 $j$ 的子段可能的最左端不会超出原序列，但可能的最右端超出了原序列，根据 $j\le i$ 还可知 $n+1-i\le n+1-j$，并且根据 $i>n-j+1$ 可知 $j>n-i+1$；
- 当 $i<j$ 且 $i>n-j+1$ 时，出现次数为 $n-j+1$，这种情况是所有长度为 $j$ 的子段可能的最左端和最右端都会超出原序列的情况，根据 $i<j$ 可知 $n+1-i>n+1-j$。

综上，可知第 $i$ 个数在长度为 $j$ 的出现次数为 $\min\{i,j,n+1-i,n+1-j\}$，因此期望式为
$$
\Large \frac{\sum_{i=1}^n a_i\sum_{j=1}^n\frac{\min\{i,j,n+1-i,n+1-j\}}{j}}{\frac{n(n+1)}{2}}
$$

后按行分段考虑 $\min\{i,j,n+1-i,n+1-j\}$ 的取值即可，线性预处理逆元后计算过程为线性复杂度。

时间复杂度：$\mathcal{O}(n)$，空间复杂度：$\mathcal{O}(n)$。

（没啥意义的 bonus：第三组样例是 osu! 的一些谱面编号 :)